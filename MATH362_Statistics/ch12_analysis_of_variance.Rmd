---
title: "CH12 Analysis of Variance"
author: "Belicia Rodriguez"
date: "4/26/2020"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(knitr)
```

# 12.3 Multiple Comparisons: Tukey's Method

## Exercise 12.3.1

Our goal is to find the following inequality for Tukey's Method:

$$\bar{Y_{.i}} - \bar{Y_{.j}} - D\sqrt{MSE} < u_i - u_j < \bar{Y_{.i}} - \bar{Y_{.j}} + D\sqrt{MSE}  $$


We will first input the dataframe into R.

```{r Case Study 12.2.1 Information}
# create vectors of dataset information
nonsmokers <- c(69, 52, 71, 58, 59, 65)
light_smokers <- c(55, 60, 78, 58, 62, 66)
moderate_smokers <- c(66, 81, 70, 77, 57, 79)
heavy_smokers <- c(91, 72, 81, 67, 95, 84)

# create dataframe
cig_heartrate <- data.frame(nonsmokers, light_smokers, moderate_smokers, heavy_smokers)

# create a separate dataframe containing the "Y.j bar" and "T.j" for each category
smoker <- c('nonsmoker', 'light_smoker', 'moderate_smoker', 'heavy_smoker')
T_dot_j <- c(374, 379, 430, 490)
Y_dot_j_hat <- c(62.3, 63.2, 71.7, 81.7) 
yj_tj <- data.frame(smoker, T_dot_j, Y_dot_j_hat)
```

Next we will calculate the various components of Tukey Method before calculating each pairwise comparison.

$$D = \frac{Q_{\alpha, k, rk-k}}{\sqrt{r}}$$

where $r = n_j$, the common sample size.

The calculations for MSE are the following:

$$MSE = \frac{SSE}{n-k}$$

$$SSE = SSTOT - SSTR$$

$$SSTOT = \sum_{j=1}^{k} \sum_{i=1}^{n_j} Y_{ij}^2 - \frac{T_{..}^2}{n}$$

$$SSTR = \sum_{j=1}^{k} \frac{T_{.j}^2}{n_j} - \frac{T_{..}^2}{n}$$

Also, $u_j$ := true mean

In this problem, $\alpha = 0.05$, $k = 4$ since there are four sample means, and $r = n_j = 6$. This would mean that $rk - k = (6*4)-4 = 20$.

```{r Calculate Components of Turkey Method}
# calculate D
Q = qtukey(0.95, nmeans = 4, df=20)
r = 6
D = Q / sqrt(r)

# calculate constant C
T = 0
for(i in colnames(cig_heartrate)){
  T = T + colSums(cig_heartrate[i])
}
T = as.numeric(T)
C = T^2/24

# calculate sum of y_ij
y_ij = 0
for(i in colnames(cig_heartrate)){
  y_ij = y_ij + colSums(cig_heartrate[i]^2)
}
y_ij = as.numeric(y_ij)

# calculate SSTOT
SSTOT = y_ij - C

# calculate SSTR
T_dot_j_sq_nj = colSums(yj_tj['T_dot_j']^2/6)
SSTR = as.numeric(T_dot_j_sq_nj - C)

# calculate SSE
SSE = SSTOT - SSTR

# calculate MSE
MSE = SSE / (24-4)

# calculate square root of MSE
sqMSE = sqrt(MSE)

# calculate D*sqMSE
D_sqMSE = D*sqMSE
```

Therefore we have that $D * \sqrt{MSE} =$ `r round(D_sqMSE,6)`.

```{r Calculate Tukey Interval}
# create list of combinations
combinations = combn(colnames(cig_heartrate), 2)

# create dataframe that contains Turkey Intervals
tukey_interval = data.frame(variable1=rep(NA,6), variable2=rep(NA,6), pairwise_diff=rep(NA, 6), tukey_lower=rep(NA,6), tukey_upper=rep(NA,6), results=rep(NA, 6))

# create for loops for matrix to calculate Turkey Intervals
for(combo in 1:6) {
  # add combination to dataframe
  variable1 = combinations[1,combo]
  variable2 = combinations[2,combo]
  
  tukey_interval[combo, 'variable1'] = variable1
  tukey_interval[combo, 'variable2'] = variable2
  
  # calculate the means for each row
  mean1 = mean(cig_heartrate[[variable1]])
  mean2 = mean(cig_heartrate[[variable2]])
  
  # calculate pairwise difference and add to dataframe
  pair_diff = mean1 - mean2
  tukey_interval[combo, 'pairwise_diff'] = round(pair_diff,3)
  
  # calculate lower bound of tukey interval
  tukey_low = round(pair_diff - D_sqMSE, 3)
  tukey_high = round(pair_diff + D_sqMSE, 3)
  
  tukey_interval[combo, 'tukey_lower'] = tukey_low
  tukey_interval[combo, 'tukey_upper'] = tukey_high
  
  # determine whether to reject H_0
  if (tukey_low < 0 && tukey_high > 0 ){
    tukey_interval[combo, 'results'] = 'do not reject H0'
  }
  else{
    tukey_interval[combo, 'results'] = 'reject H0'
  }
}
```


```{r Display Table, results='asis'}
tukey_interval %>% kable()
```

I will also display how to find the above table using the ANOVA and Tukey functions shown in class.

```{r}
# create gathered dataframe
cig_heart_gather = cig_heartrate %>% gather("group", "rate")

# change group column from string to categorical
cig_heart_gather$group <- as.factor(cig_heart_gather$group)

# order the categories
cig_heart_gather$group <- ordered(cig_heart_gather$group, levels = c("nonsmokers", "light_smokers","moderate_smokers", "heavy_smokers"))

# calculate ANOVA table
anova <- aov(rate~group, data=cig_heart_gather)
summary(anova)

# calculate tukey
TukeyHSD(anova)
```

The two tables match. Therefore, our results column in the first table has the correct conclusions.

## Exercise 12.3.4

```{r}
# create vectors of dataset information
variety1 = c(46.2, 51.9, 48.7)
variety2 = c(49.2, 58.6, 57.6)
variety3 = c(60.3, 58.7, 60.4)
variety4 = c(48.9, 51.4, 44.6)
variety5 = c(52.5, 54.0, 49.3)

# create dataframe
corn = data.frame(variety1, variety2, variety3, variety4, variety5)

# restructre dataframe
corn = corn %>% gather("variety", "yield")

# change variety variable from string to categorical
corn$variety <- as.factor(corn$variety)

# calculate ANOVA table
corn_anova <- aov(yield~variety, data=corn)
summary(corn_anova)

# calculate Tukey intervals
TukeyHSD(corn_anova)
```

